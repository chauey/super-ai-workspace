<div class="app-container" [class.dark]="isDark()" [attr.data-theme]="theme()" [attr.data-layout]="layout()" [attr.data-density]="densityMode()">
  <!-- Top Toolbar -->
  <mat-toolbar class="app-toolbar">
    <div class="toolbar-left">
      <button mat-icon-button (click)="toggleSidebar()" class="sidebar-toggle">
        <mat-icon>menu</mat-icon>
      </button>
      <div class="app-logo">
        <mat-icon class="logo-icon">dashboard</mat-icon>
        <span class="logo-text" [class.compact]="sidebarCompact()">Super AI Guide</span>
      </div>
    </div>

    <div class="toolbar-spacer"></div>

    <div class="toolbar-actions">
      <!-- Layout Toggle -->
      <button mat-icon-button [matMenuTriggerFor]="layoutMenu" matTooltip="Layout Options">
        <mat-icon>view_quilt</mat-icon>
      </button>

      <!-- Theme Toggle -->
      <button mat-icon-button (click)="toggleTheme()" [matTooltip]="theme() === 'system' ? 'System Theme' : (isDark() ? 'Switch to Light' : 'Switch to Dark')">
        <mat-icon>{{ isDark() ? 'light_mode' : 'dark_mode' }}</mat-icon>
      </button>

      <!-- Settings Menu -->
      <button mat-icon-button [matMenuTriggerFor]="settingsMenu" matTooltip="Settings">
        <mat-icon>settings</mat-icon>
      </button>
    </div>
  </mat-toolbar>

  <!-- Layout Menu -->
  <mat-menu #layoutMenu="matMenu">
    <button mat-menu-item (click)="setLayout('default')" [class.active]="layout() === 'default'">
      <mat-icon>view_quilt</mat-icon>
      <span>Default Layout</span>
    </button>
    <button mat-menu-item (click)="setLayout('compact')" [class.active]="layout() === 'compact'">
      <mat-icon>view_compact</mat-icon>
      <span>Compact Layout</span>
    </button>
    <button mat-menu-item (click)="setLayout('minimal')" [class.active]="layout() === 'minimal'">
      <mat-icon>view_module</mat-icon>
      <span>Minimal Layout</span>
    </button>
  </mat-menu>

  <!-- Settings Menu -->
  <mat-menu #settingsMenu="matMenu">
    <button mat-menu-item (click)="setTheme('light')" [class.active]="theme() === 'light'">
      <mat-icon>light_mode</mat-icon>
      <span>Light Theme</span>
    </button>
    <button mat-menu-item (click)="setTheme('dark')" [class.active]="theme() === 'dark'">
      <mat-icon>dark_mode</mat-icon>
      <span>Dark Theme</span>
    </button>
    <button mat-menu-item (click)="setTheme('system')" [class.active]="theme() === 'system'">
      <mat-icon>brightness_auto</mat-icon>
      <span>System Theme</span>
    </button>
    <mat-divider></mat-divider>
    <button mat-menu-item [matMenuTriggerFor]="densityMenu">
      <mat-icon>format_line_spacing</mat-icon>
      <span>Density</span>
    </button>
    <mat-divider></mat-divider>
    <button mat-menu-item (click)="toggleSidebarCompact()">
      <mat-icon>{{ sidebarCompact() ? 'unfold_more' : 'fold_more' }}</mat-icon>
      <span>{{ sidebarCompact() ? 'Expand Sidebar' : 'Compact Sidebar' }}</span>
    </button>
  </mat-menu>

  <!-- Density Menu -->
  <mat-menu #densityMenu="matMenu">
    <button mat-menu-item (click)="setDensity('default')" [class.active]="densityMode() === 'default'">
      <mat-icon>{{ densityMode() === 'default' ? 'radio_button_checked' : 'radio_button_unchecked' }}</mat-icon>
      <span>Default</span>
    </button>
    <button mat-menu-item (click)="setDensity('comfortable')" [class.active]="densityMode() === 'comfortable'">
      <mat-icon>{{ densityMode() === 'comfortable' ? 'radio_button_checked' : 'radio_button_unchecked' }}</mat-icon>
      <span>Comfortable</span>
    </button>
    <button mat-menu-item (click)="setDensity('compact')" [class.active]="densityMode() === 'compact'">
      <mat-icon>{{ densityMode() === 'compact' ? 'radio_button_checked' : 'radio_button_unchecked' }}</mat-icon>
      <span>Compact</span>
    </button>
    <button mat-menu-item (click)="setDensity('super-compact')" [class.active]="densityMode() === 'super-compact'">
      <mat-icon>{{ densityMode() === 'super-compact' ? 'radio_button_checked' : 'radio_button_unchecked' }}</mat-icon>
      <span>Super Compact</span>
    </button>
  </mat-menu>

  <!-- Main Layout -->
  <mat-sidenav-container class="app-sidenav-container">
    <!-- Sidebar -->
    <mat-sidenav
      #sidenav
      [mode]="sidebarMode()"
      [opened]="sidebarOpen()"
      [style.width]="sidebarWidth()"
      class="app-sidenav"
      [class.compact]="sidebarCompact()">

      <!-- Sidebar Header -->
      <div class="sidebar-header" *ngIf="!sidebarCompact()">
        <div class="sidebar-title">
          <mat-icon>navigation</mat-icon>
          <span>Navigation</span>
        </div>
        <div class="sidebar-actions">
          <button mat-icon-button (click)="expandAll()" matTooltip="Expand All" size="small">
            <mat-icon>expand_more</mat-icon>
          </button>
          <button mat-icon-button (click)="collapseAll()" matTooltip="Collapse All" size="small">
            <mat-icon>expand_less</mat-icon>
          </button>
        </div>
      </div>

      <!-- Navigation Items -->
      <div class="navigation-content">
        <!-- Loading State -->
        @if (navigationService.loading()) {
          <div class="nav-loading">
            <mat-spinner diameter="24"></mat-spinner>
            <span>Loading navigation...</span>
          </div>
        }

        <!-- Navigation Items -->
        @if (!navigationService.loading() && navigationService.hasNavigationItems()) {
          @for (item of navigationService.navigationItems(); track item.id) {
            <div class="nav-section">
              <!-- Section Header (with route) -->
              @if (item.route && !item.children) {
                <a
                  [routerLink]="item.route"
                  routerLinkActive="active"
                  class="nav-section-header nav-section-link"
                  [matTooltip]="sidebarCompact() ? item.tooltip : ''"
                  matTooltipPosition="right">
                  <div class="nav-section-title">
                    <mat-icon>{{ item.icon }}</mat-icon>
                    <span *ngIf="!sidebarCompact()">{{ item.title }}</span>
                    @if (item.badge && !sidebarCompact()) {
                      <mat-chip [color]="item.badgeColor || 'primary'">
                        {{ item.badge }}
                      </mat-chip>
                    }
                  </div>
                </a>
              }

              <!-- Section Header (with children) - now also navigates if has route -->
              @if (item.children) {
                <div
                  class="nav-section-header"
                  [class.expanded]="isPanelExpanded(item.id)"
                  [matTooltip]="sidebarCompact() ? item.tooltip : ''"
                  matTooltipPosition="right">
                  <!-- Clickable title that navigates if route exists -->
                  @if (item.route) {
                    <a
                      [routerLink]="item.route"
                      routerLinkActive="active"
                      class="nav-section-title nav-title-link"
                      (click)="item.children && ensureExpanded(item.id); $event.stopPropagation()">
                      <mat-icon>{{ item.icon }}</mat-icon>
                      <span *ngIf="!sidebarCompact()">{{ item.title }}</span>
                      @if (item.badge && !sidebarCompact()) {
                        <mat-chip [color]="item.badgeColor || 'primary'" class="ml-2">
                          {{ item.badge }}
                        </mat-chip>
                      }
                    </a>
                  } @else {
                    <div class="nav-section-title" (click)="togglePanel(item.id)">
                      <mat-icon>{{ item.icon }}</mat-icon>
                      <span *ngIf="!sidebarCompact()">{{ item.title }}</span>
                      @if (item.badge && !sidebarCompact()) {
                        <mat-chip [color]="item.badgeColor || 'primary'" class="ml-2">
                          {{ item.badge }}
                        </mat-chip>
                      }
                    </div>
                  }
                  <!-- Expand/collapse icon (always toggles children) -->
                  <mat-icon class="expand-icon" *ngIf="!sidebarCompact()" (click)="togglePanel(item.id)">
                    {{ isPanelExpanded(item.id) ? 'expand_less' : 'expand_more' }}
                  </mat-icon>
                </div>

                <!-- Section Items (children) -->
                <div
                  class="nav-section-items"
                  [class.expanded]="isPanelExpanded(item.id)">
                  @for (child of item.children; track child.id) {
                    <!-- Child with no sub-children -->
                    @if (!child.children) {
                      <a
                        mat-list-item
                        [routerLink]="child.route"
                        routerLinkActive="active"
                        class="nav-item"
                        [matTooltip]="sidebarCompact() ? (child.tooltip || child.title) : ''"
                        matTooltipPosition="right">
                        <mat-icon matListItemIcon>{{ child.icon }}</mat-icon>
                        <span matListItemTitle *ngIf="!sidebarCompact()">{{ child.title }}</span>
                        @if (child.badge && !sidebarCompact()) {
                          <mat-chip matListItemMeta [color]="child.badgeColor || 'primary'">
                            {{ child.badge }}
                          </mat-chip>
                        }
                      </a>
                    }

                    <!-- Child with sub-children (nested) -->
                    @if (child.children) {
                      <div class="nav-subsection">
                        <div
                          class="nav-subsection-header"
                          [class.expanded]="isPanelExpanded(child.id)">
                          <!-- Clickable title that navigates if route exists -->
                          @if (child.route) {
                            <a
                              [routerLink]="child.route"
                              routerLinkActive="active"
                              class="nav-subsection-title"
                              (click)="child.children && ensureExpanded(child.id); $event.stopPropagation()">
                              <mat-icon>{{ child.icon }}</mat-icon>
                              <span *ngIf="!sidebarCompact()">{{ child.title }}</span>
                            </a>
                          } @else {
                            <div class="nav-subsection-title" (click)="togglePanel(child.id)">
                              <mat-icon>{{ child.icon }}</mat-icon>
                              <span *ngIf="!sidebarCompact()">{{ child.title }}</span>
                            </div>
                          }
                          <mat-icon class="expand-icon" *ngIf="!sidebarCompact()" (click)="togglePanel(child.id)">
                            {{ isPanelExpanded(child.id) ? 'expand_less' : 'expand_more' }}
                          </mat-icon>
                        </div>

                        <div
                          class="nav-subsection-items"
                          [class.expanded]="isPanelExpanded(child.id)">
                          @for (grandchild of child.children; track grandchild.id) {
                            <!-- Grandchild with no sub-children -->
                            @if (!grandchild.children) {
                              <a
                                mat-list-item
                                [routerLink]="grandchild.route"
                                routerLinkActive="active"
                                class="nav-item nav-grandchild"
                                [matTooltip]="sidebarCompact() ? (grandchild.tooltip || grandchild.title) : ''"
                                matTooltipPosition="right">
                                <mat-icon matListItemIcon>{{ grandchild.icon }}</mat-icon>
                                <span matListItemTitle *ngIf="!sidebarCompact()">{{ grandchild.title }}</span>
                              </a>
                            }

                            <!-- Grandchild with sub-children (4th level) -->
                            @if (grandchild.children) {
                              <div class="nav-subsection nav-level-4">
                                <div
                                  class="nav-subsection-header"
                                  [class.expanded]="isPanelExpanded(grandchild.id)">
                                  @if (grandchild.route) {
                                    <a
                                      [routerLink]="grandchild.route"
                                      routerLinkActive="active"
                                      class="nav-subsection-title"
                                      (click)="grandchild.children && ensureExpanded(grandchild.id); $event.stopPropagation()">
                                      <mat-icon>{{ grandchild.icon }}</mat-icon>
                                      <span *ngIf="!sidebarCompact()">{{ grandchild.title }}</span>
                                    </a>
                                  } @else {
                                    <div class="nav-subsection-title" (click)="togglePanel(grandchild.id)">
                                      <mat-icon>{{ grandchild.icon }}</mat-icon>
                                      <span *ngIf="!sidebarCompact()">{{ grandchild.title }}</span>
                                    </div>
                                  }
                                  <mat-icon class="expand-icon" *ngIf="!sidebarCompact()" (click)="togglePanel(grandchild.id)">
                                    {{ isPanelExpanded(grandchild.id) ? 'expand_less' : 'expand_more' }}
                                  </mat-icon>
                                </div>

                                <div
                                  class="nav-subsection-items"
                                  [class.expanded]="isPanelExpanded(grandchild.id)">
                                  @for (greatgrandchild of grandchild.children; track greatgrandchild.id) {
                                    <a
                                      mat-list-item
                                      [routerLink]="greatgrandchild.route"
                                      routerLinkActive="active"
                                      class="nav-item nav-greatgrandchild"
                                      [matTooltip]="sidebarCompact() ? (greatgrandchild.tooltip || greatgrandchild.title) : ''"
                                      matTooltipPosition="right">
                                      <mat-icon matListItemIcon>{{ greatgrandchild.icon }}</mat-icon>
                                      <span matListItemTitle *ngIf="!sidebarCompact()">{{ greatgrandchild.title }}</span>
                                    </a>
                                  }
                                </div>
                              </div>
                            }
                          }
                        </div>
                      </div>
                    }
                  }
                </div>
              }
            </div>
          }
        }

        <!-- No Navigation Items -->
        @if (!navigationService.loading() && !navigationService.hasNavigationItems()) {
          <div class="nav-empty">
            <mat-icon>navigation</mat-icon>
            <span>No navigation items available</span>
          </div>
        }
      </div>
    </mat-sidenav>

    <!-- Main Content -->
    <mat-sidenav-content class="app-content">
      <div class="content-wrapper">
        <!-- Router Outlet -->
        <router-outlet />
      </div>
    </mat-sidenav-content>
  </mat-sidenav-container>
</div>

